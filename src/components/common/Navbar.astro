---
import '@/assets/styles/navbar.css';
import { LINKS } from '@/lib/constants';

const links = [
  { href: LINKS.home, text: 'Home' },
  { href: '/#about', text: 'About' },
  { href: '/#experience', text: 'Experience' },
  { href: '/#projects', text: 'Projects' },
  { href: LINKS.blog, text: 'Blog' },
];

// Get current page path for active link highlighting
const currentPath = Astro.url.pathname;
const currentHash = Astro.url.hash;
---

<nav class="navbar">
  <div class="logo">
    <span>PR</span>
  </div>

  <div class="nav-right">
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle light/dark mode">
      <svg
        id="icon-sun"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        style="display: none;"
      >
        <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"></circle>
        <path d="M12 1V3" stroke="currentColor" stroke-width="2"></path>
        <path d="M12 21V23" stroke="currentColor" stroke-width="2"></path>
        <path d="M4.22 4.22L5.64 5.64" stroke="currentColor" stroke-width="2"></path>
        <path d="M18.36 18.36L19.78 19.78" stroke="currentColor" stroke-width="2"></path>
        <path d="M1 12H3" stroke="currentColor" stroke-width="2"></path>
        <path d="M21 12H23" stroke="currentColor" stroke-width="2"></path>
        <path d="M4.22 19.78L5.64 18.36" stroke="currentColor" stroke-width="2"></path>
        <path d="M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2"></path>
      </svg>
      <svg
        id="icon-moon"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        style="display: none;"
      >
        <path
          d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"
          stroke="currentColor"
          stroke-width="2"></path>
      </svg>
    </button>
    <button
      class="menu-toggle"
      id="menu-toggle"
      aria-label="Toggle menu"
      aria-controls="nav-links"
      aria-expanded="false"
    >
      <span class="sr-only">Toggle navigation</span>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </button>
    <ul class="nav-links" id="nav-links" aria-hidden="true">
      {
        links.map((link) => {
          let isActive = false;
          // Only mark Blog as active if on /blog or subpages
          if (link.href === '/blog' && currentPath.startsWith('/blog')) {
            isActive = true;
          }
          return (
            <li>
              <a href={link.href} class={isActive ? 'active' : ''} tabindex="0">
                {link.text}
              </a>
            </li>
          );
        })
      }
    </ul>
  </div>
</nav>
<noscript>
  <style>
    .menu-toggle {
      display: none !important;
    }
    .nav-links {
      display: flex !important;
      position: static !important;
      height: auto !important;
    }
  </style>
</noscript>

<script client:load>
  const themeToggle = document.getElementById('theme-toggle');
  const iconSun = document.getElementById('icon-sun');
  const iconMoon = document.getElementById('icon-moon');
  const menuToggle = document.getElementById('menu-toggle');
  const navLinks = document.getElementById('nav-links');

  function applyTheme(isDark) {
    document.body.classList.toggle('dark', isDark);
    if (iconSun) iconSun.style.display = isDark ? 'inline' : 'none';
    if (iconMoon) iconMoon.style.display = isDark ? 'none' : 'inline';
  }

  function updateTheme() {
    const userPref = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(userPref ? userPref === 'dark' : systemPrefersDark);
  }

  // Listen for system theme changes
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  mediaQuery.addEventListener('change', () => {
    if (!localStorage.getItem('theme')) {
      updateTheme();
    }
  });

  // Set theme on initial load
  updateTheme();

  // Handle toggle click
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const isCurrentlyDark = document.body.classList.contains('dark');
      localStorage.setItem('theme', !isCurrentlyDark ? 'dark' : 'light');
      updateTheme();
    });
  }

  // Hamburger menu logic
  if (menuToggle && navLinks) {
    menuToggle.addEventListener('click', () => {
      navLinks.classList.toggle('active');
      // Set aria-expanded for accessibility
      const expanded = navLinks.classList.contains('active');
      menuToggle.setAttribute('aria-expanded', expanded);
      navLinks.setAttribute('aria-hidden', !expanded);
    });
    // Optional: close menu when a link is clicked (for better UX)
    navLinks.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        navLinks.classList.remove('active');
        menuToggle.setAttribute('aria-expanded', 'false');
        navLinks.setAttribute('aria-hidden', 'true');
      });
    });
  }

  // --- Scroll Tracker for Active Navigation Links ---
  function updateActiveNavLink() {
    const navLinksA = document.querySelectorAll('.nav-links a');
    const currentPath = window.location.pathname;
    const currentHash = window.location.hash;

    navLinksA.forEach((link) => {
      const linkHref = link.getAttribute('href');
      link.classList.remove('active'); // Always remove first

      if (linkHref === currentPath + currentHash) {
        link.classList.add('active');
      } else if (linkHref === '/blog' && currentPath.startsWith('/blog')) {
        link.classList.add('active');
      } else if (linkHref === '/' && currentPath === '/' && !currentHash) {
        link.classList.add('active');
      }
    });
  }

  // Scroll-based active link detection
  function updateActiveNavOnScroll() {
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav-links a');
    const scrollPosition = window.scrollY + 150; // Offset for navbar height

    let activeSection = '';

    // Find which section is currently in view
    sections.forEach((section) => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.offsetHeight;
      const sectionId = section.getAttribute('id');

      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
        activeSection = sectionId;
      }
    });

    // Update nav links based on active section
    navLinks.forEach((link) => {
      link.classList.remove('active');
      const href = link.getAttribute('href');

      // Check if link matches current section
      if (href === `/#${activeSection}` || (href === '/' && activeSection === 'home')) {
        link.classList.add('active');
      }
      // Keep blog link active when on blog pages
      else if (href === '/blog' && window.location.pathname.startsWith('/blog')) {
        link.classList.add('active');
      }
    });
  }

  // Throttle scroll events for better performance
  let scrollTimeout;
  function throttledScrollHandler() {
    if (scrollTimeout) {
      cancelAnimationFrame(scrollTimeout);
    }
    scrollTimeout = requestAnimationFrame(() => {
      updateActiveNavOnScroll();
    });
  }

  // Event listeners
  window.addEventListener('scroll', throttledScrollHandler);
  window.addEventListener('hashchange', updateActiveNavLink);
  window.addEventListener('popstate', updateActiveNavLink);
  window.addEventListener('resize', updateActiveNavOnScroll);

  document.addEventListener('DOMContentLoaded', () => {
    updateActiveNavLink();
    updateActiveNavOnScroll();
  });

  // Handle nav link clicks
  document.querySelectorAll('.nav-links a').forEach((link) => {
    link.addEventListener('click', function () {
      // Small delay to allow scroll to happen
      setTimeout(() => {
        updateActiveNavOnScroll();
      }, 100);
    });
  });
</script>
