---
const { volume = 0.3, soundUrl = '/click.mp3', enableOnMobile = true } = Astro.props;
---

<script define:vars={{ volume, soundUrl, enableOnMobile }}>
  class KeypressSound {
    constructor(volume, soundUrl, enableOnMobile) {
      this.volume = volume;
      this.soundUrl = soundUrl;
      this.enableOnMobile = enableOnMobile;
      this.audio = null;
      this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      );
      this.isInitialized = false;

      this.init();
    }

    init() {
      // Don't initialize on mobile if disabled
      if (this.isMobile && !this.enableOnMobile) {
        return;
      }

      // Create audio element
      this.audio = new Audio(this.soundUrl);
      this.audio.volume = this.volume;
      this.audio.preload = 'auto';

      // Wait for DOM to be ready before adding listeners
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          this.addEventListeners();
        });
      } else {
        // DOM is already ready, add listeners immediately
        setTimeout(() => this.addEventListeners(), 100);
      }
    }

    addEventListeners() {
      if (this.isInitialized) return;

      this.addClickListeners();
      this.addKeyboardListeners();
      this.isInitialized = true;
    }

    playSound() {
      if (!this.audio) return;

      try {
        this.audio.currentTime = 0;
        this.audio.play().catch((e) => {
          console.debug('Audio play failed:', e);
        });
      } catch (error) {
        console.debug('Audio play error:', error);
      }
    }

    addClickListeners() {
      // Handle navigation links with delay for page navigation
      document.addEventListener(
        'click',
        (e) => {
          const target = e.target;
          const link = target.closest('a');

          if (link) {
            const href = link.getAttribute('href');
            const isNavLink = link.closest('.nav-links') || link.closest('.logo');

            // Check if it's a navigation link that will cause page navigation
            if (isNavLink && (href === '/' || href === '/blog' || href?.startsWith('/blog'))) {
              e.preventDefault(); // Prevent immediate navigation

              this.playSound();

              // Navigate after sound has time to play
              setTimeout(() => {
                window.location.href = href;
              }, 150);

              return;
            }

            // For hash links or other links, play sound normally
            if (isNavLink) {
              this.playSound();
              return;
            }
          }

          // Handle other clickable elements
          const clickableElement = target.closest(
            'button, [role="button"], input[type="button"], input[type="submit"], input[type="reset"], .clickable, [data-sound]'
          );

          if (clickableElement) {
            this.playSound();
          }
        },
        true
      );
    }

    addKeyboardListeners() {
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          const target = e.target;
          const isInteractive =
            target.matches('button, a, [role="button"], input, select, textarea') ||
            target.hasAttribute('data-sound') ||
            target.closest('[data-sound]');

          if (isInteractive) {
            // Special handling for navigation links
            const link = target.closest('a');
            if (link) {
              const href = link.getAttribute('href');
              const isNavLink = link.closest('.nav-links') || link.closest('.logo');

              if (isNavLink && (href === '/' || href === '/blog' || href?.startsWith('/blog'))) {
                e.preventDefault();
                this.playSound();

                setTimeout(() => {
                  window.location.href = href;
                }, 150);

                return;
              }
            }

            this.playSound();
          }
        }
      });
    }

    // Method to manually trigger sound
    trigger() {
      this.playSound();
    }

    // Method to update volume
    setVolume(newVolume) {
      this.volume = Math.max(0, Math.min(1, newVolume));
      if (this.audio) {
        this.audio.volume = this.volume;
      }
    }

    // Method to enable/disable
    destroy() {
      if (this.audio) {
        this.audio = null;
      }
      this.isInitialized = false;
    }

    // Method to reinitialize if needed
    reinit() {
      if (!this.isInitialized) {
        this.addEventListeners();
      }
    }
  }

  // Initialize the sound system
  function initializeKeypressSound() {
    if (!window.keypressSound) {
      window.keypressSound = new KeypressSound(volume, soundUrl, enableOnMobile);
    } else {
      window.keypressSound.reinit();
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeKeypressSound);
  } else {
    initializeKeypressSound();
  }

  // Also initialize on page navigation
  window.addEventListener('load', initializeKeypressSound);
</script>
