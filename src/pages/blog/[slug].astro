---
import { getCollection, getEntryBySlug, type CollectionEntry } from 'astro:content';
import BackIcon from '@/components/common/Back.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import '@/assets/styles/index.css';
import '@/assets/styles/blog/blog-post.css';
import ClickSound from '@/components/common/UISound.astro';
import BookmarkIcon from '@/assets/icons/bookmark.svg?raw';
import ShareIcon from '@/assets/icons/share.svg?raw';

export async function getStaticPaths() {
  const posts = await getCollection<'blog'>('blog');
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
// @ts-ignore - Type issue with content collections
const post = (await getEntryBySlug('blog', slug!)) as CollectionEntry<'blog'>;
if (!post) throw new Error('Post not found');

const { Content } = await post.render();

// Calculate reading time and word count
const content = post.body;
const words = content.split(/\s+/).length;
const readingTime = Math.ceil(words / 200); // 200 words per minute

// Extract keywords from content (simple extraction)
const extractKeywords = (text: string, title: string) => {
  const commonWords = [
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'in',
    'on',
    'at',
    'to',
    'for',
    'of',
    'with',
    'by',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'have',
    'has',
    'had',
    'do',
    'does',
    'did',
    'will',
    'would',
    'could',
    'should',
  ];
  const titleWords = title
    .toLowerCase()
    .split(/\s+/)
    .filter((word) => word.length > 3 && !commonWords.includes(word));
  const contentWords = text.toLowerCase().match(/\b\w{4,}\b/g) || [];
  const wordFreq: Record<string, number> = {};

  // Count title words with higher weight
  titleWords.forEach((word) => {
    wordFreq[word] = (wordFreq[word] || 0) + 3;
  });

  // Count content words
  contentWords.forEach((word) => {
    if (!commonWords.includes(word)) {
      wordFreq[word] = (wordFreq[word] || 0) + 1;
    }
  });

  // Return top keywords
  return Object.entries(wordFreq)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 10)
    .map(([word]) => word);
};

const keywords = extractKeywords(content, post.data.title);

// Enhanced meta data for blog posts
const meta = {
  title: `${post.data.title} | Prakash Raj Blog`,
  description: post.data.excerpt,
  image: post.data.image,
  canonicalURL: Astro.url.href,
  type: 'article' as const,
  publishedTime: new Date(post.data.date).toISOString(),
  modifiedTime: new Date(post.data.date).toISOString(), // You can add a modified date field to your content schema
  author: 'Prakash Raj',
  keywords: [...keywords, 'Prakash Raj', 'Blog', 'Technology', 'Web Development', 'Programming'],
  structuredDataType: 'BlogPosting' as const,
  wordCount: words,
  category: 'Technology', // You can add categories to your content schema
  articleBody: content.substring(0, 1000) + '...', // First 1000 chars for schema
  additionalStructuredData: {
    readingTime: `PT${readingTime}M`,
    wordCount: words,
    // Removed breadcrumb data since we're removing the visual breadcrumb
    publisher: {
      '@type': 'Organization',
      name: 'Prakash Raj',
      logo: {
        '@type': 'ImageObject',
        url: 'https://prakashraj.info/assets/images/PR.png',
      },
    },
  },
};
---

<MainLayout meta={meta}>
  <ClickSound />
  <div class="container">
    <!-- Removed Breadcrumb component -->
    <BackIcon />
    <article class="blog-post">
      <header class="post-header">
        <div class="title-section">
          <h1 class="post-title">{post.data.title}</h1>
          <div class="title-actions">
            <button class="action-btn bookmark-btn" title="Bookmark this article">
              <Fragment set:html={BookmarkIcon} />
            </button>
            <button class="action-btn share-btn" title="Share this article">
              <Fragment set:html={ShareIcon} />
            </button>
          </div>
        </div>
        <div class="post-meta">
          <div class="meta-left">
            <div class="author-section">
              <img src="/assets/images/Prakash_Raj.jpg" alt="Prakash Raj" class="author-photo" />
              <div class="author-details">
                <span class="author-name">Prakash Raj</span>
                <div class="author-meta">
                  <span class="post-date">
                    {
                      new Date(post.data.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })
                    }
                  </span>
                  <span class="meta-separator">â€¢</span>
                  <span class="read-time">{readingTime} min read</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="post-content">
        <Content />
      </div>
    </article>
  </div>
</MainLayout>

<script>
  // Bookmark notification function
  function showBookmarkNotification(message: string, type: string) {
    const notification = document.createElement('div');
    notification.className = `bookmark-notification ${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);

    // Remove after 4 seconds
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }

  // Bookmark functionality
  document.addEventListener('DOMContentLoaded', () => {
    const bookmarkBtn = document.querySelector('.bookmark-btn') as HTMLButtonElement;
    const shareBtn = document.querySelector('.share-btn') as HTMLButtonElement;

    // Check if article is already bookmarked
    const currentUrl = window.location.href;
    const bookmarks = JSON.parse(localStorage.getItem('bookmarked-articles') || '[]');

    if (bookmarks.includes(currentUrl)) {
      bookmarkBtn?.classList.add('bookmarked');
    }

    // Bookmark toggle
    bookmarkBtn?.addEventListener('click', async () => {
      const bookmarks = JSON.parse(localStorage.getItem('bookmarked-articles') || '[]');
      const currentUrl = window.location.href;
      const pageTitle = document.title;

      if (bookmarks.includes(currentUrl)) {
        // Remove bookmark
        const updatedBookmarks = bookmarks.filter((url) => url !== currentUrl);
        localStorage.setItem('bookmarked-articles', JSON.stringify(updatedBookmarks));
        bookmarkBtn.classList.remove('bookmarked');
        bookmarkBtn.title = 'Bookmark this article';

        showBookmarkNotification('Removed from your reading list', 'removed');
      } else {
        // Add bookmark
        bookmarks.push(currentUrl);
        localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarks));
        bookmarkBtn.classList.add('bookmarked');
        bookmarkBtn.title = 'Remove bookmark';

        // Try to add to browser bookmarks (limited browser support)
        try {
          // @ts-ignore - Legacy browser APIs
          if (window.external && window.external.AddFavorite) {
            // @ts-ignore
            window.external.AddFavorite(currentUrl, pageTitle);
            showBookmarkNotification('Added to browser bookmarks!', 'added');
            // @ts-ignore - Legacy browser APIs
          } else if (window.sidebar && window.sidebar.addPanel) {
            // @ts-ignore
            window.sidebar.addPanel(pageTitle, currentUrl, '');
            showBookmarkNotification('Added to browser bookmarks!', 'added');
          } else {
            // Modern browsers - show instruction
            showBookmarkNotification('Added to reading list.', 'instruction');
          }
        } catch (e) {
          // Fallback: show instruction
          showBookmarkNotification(
            'Added to reading list. Press Ctrl+D (Cmd+D on Mac) to bookmark in browser',
            'instruction'
          );
        }
      }
    });

    // Share functionality
    shareBtn?.addEventListener('click', async () => {
      const shareData = {
        title: document.title,
        text: document.querySelector('meta[name="description"]')?.getAttribute('content') || '',
        url: window.location.href,
      };

      if (navigator.share) {
        try {
          await navigator.share(shareData);
        } catch (err) {
          console.log('Error sharing:', err);
        }
      } else {
        // Fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);
          shareBtn.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M 9 2 L 9 4 L 19 4 L 19 14 L 21 14 L 21 2 L 9 2 z M 3 8 L 3 22 L 17 22 L 17 8 L 3 8 z M 5 10 L 15 10 L 15 20 L 5 20 L 5 10 z"/></svg>';
          shareBtn.title = 'Link copied!';

          setTimeout(() => {
            shareBtn.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M 16.707031 2.2929688 L 15.292969 3.7070312 L 17.585938 6 L 17 6 C 10.936593 6 6 10.936593 6 17 L 6 18 L 8 18 L 8 17 C 8 12.017407 12.017407 8 17 8 L 17.585938 8 L 15.292969 10.292969 L 16.707031 11.707031 L 21.414062 7 L 16.707031 2.2929688 z M 2 8 L 2 9 L 2 22 L 22 22 L 22 18 L 22 17 L 20 17 L 20 18 L 20 20 L 4 20 L 4 9 L 4 8 L 2 8 z"/></svg>';
            shareBtn.title = 'Share this article';
          }, 2000);
        } catch (err) {
          console.log('Error copying to clipboard:', err);
        }
      }
    });
  });
</script>
