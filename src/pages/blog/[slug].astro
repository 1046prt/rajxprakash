---
import { getCollection, getEntryBySlug, type CollectionEntry } from 'astro:content';
import BackIcon from '@/components/common/Back.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import '@/assets/styles/index.css';
import '@/assets/styles/blog/blog-post.css';
import ClickSound from '@/components/common/UISound.astro';
import BookmarkIcon from '@/assets/icons/bookmark.svg?raw';
import ShareIcon from '@/assets/icons/share.svg?raw';

export async function getStaticPaths() {
  const posts = await getCollection<'blog'>('blog');
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
// @ts-ignore - Type issue with content collections
const post = (await getEntryBySlug('blog', slug!)) as CollectionEntry<'blog'>;
if (!post) throw new Error('Post not found');

const { Content } = await post.render();

// Calculate reading time and word count
const content = post.body;
const words = content.split(/\s+/).length;
const readingTime = Math.ceil(words / 200); // 200 words per minute

// Extract keywords from content (simple extraction)
const extractKeywords = (text: string, title: string) => {
  const commonWords = [
    'the',
    'a',
    'an',
    'and',
    'or',
    'but',
    'in',
    'on',
    'at',
    'to',
    'for',
    'of',
    'with',
    'by',
    'is',
    'are',
    'was',
    'were',
    'be',
    'been',
    'have',
    'has',
    'had',
    'do',
    'does',
    'did',
    'will',
    'would',
    'could',
    'should',
  ];
  const titleWords = title
    .toLowerCase()
    .split(/\s+/)
    .filter((word) => word.length > 3 && !commonWords.includes(word));
  const contentWords = text.toLowerCase().match(/\b\w{4,}\b/g) || [];
  const wordFreq: Record<string, number> = {};

  // Count title words with higher weight
  titleWords.forEach((word) => {
    wordFreq[word] = (wordFreq[word] || 0) + 3;
  });

  // Count content words
  contentWords.forEach((word) => {
    if (!commonWords.includes(word)) {
      wordFreq[word] = (wordFreq[word] || 0) + 1;
    }
  });

  // Return top keywords
  return Object.entries(wordFreq)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 10)
    .map(([word]) => word);
};

const keywords = extractKeywords(content, post.data.title);

// Enhanced meta data for blog posts
const meta = {
  title: `${post.data.title} | Prakash Raj Blog`,
  description: post.data.excerpt,
  image: post.data.image
    ? post.data.image.startsWith('http')
      ? post.data.image
      : `https://prakashraj.info${post.data.image}`
    : 'https://prakashraj.info/assets/images/Blog.png',
  canonicalURL: Astro.url.href,
  type: 'article' as const,
  publishedTime: new Date(post.data.date).toISOString(),
  modifiedTime: new Date(post.data.date).toISOString(),
  author: 'Prakash Raj',
  keywords: [...keywords, 'Prakash Raj', 'Blog', 'Technology', 'Web Development', 'Programming'],
  structuredDataType: 'BlogPosting' as const,
  wordCount: words,
  category: 'Technology', // You can add categories to your content schema
  articleBody: content.substring(0, 1000) + '...', // First 1000 chars for schema
  additionalStructuredData: {
    readingTime: `PT${readingTime}M`,
    wordCount: words,
    // Removed breadcrumb data since we're removing the visual breadcrumb
    publisher: {
      '@type': 'Organization',
      name: 'Prakash Raj',
      logo: {
        '@type': 'ImageObject',
        url: 'https://prakashraj.info/assets/images/PR.png',
      },
    },
  },
};
---

<MainLayout meta={meta}>
  <ClickSound />
  <div class="container">
    <!-- Removed Breadcrumb component -->
    <BackIcon />
    <article class="blog-post">
      <header class="post-header">
        <div class="title-section">
          <h1 class="post-title">{post.data.title}</h1>
          <div class="title-actions">
            <button class="action-btn bookmark-btn" title="Bookmark this article">
              <Fragment set:html={BookmarkIcon} />
            </button>
            <button class="action-btn share-btn share-chip" title="Share this article">
              <Fragment set:html={ShareIcon} />
              <span class="share-text">Share</span>
            </button>
          </div>
        </div>
        <div class="post-meta">
          <div class="meta-left">
            <div class="author-section">
              <img src="/assets/images/Prakash_Raj.jpg" alt="Prakash Raj" class="author-photo" />
              <div class="author-details">
                <span class="author-name">Prakash Raj</span>
                <div class="author-meta">
                  <span class="post-date">
                    {
                      new Date(post.data.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })
                    }
                  </span>
                  <span class="meta-separator">â€¢</span>
                  <span class="read-time">{readingTime} min read</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="post-content">
        <Content />
      </div>
    </article>
  </div>
</MainLayout>

<script>
  // Simple bookmark functionality with localStorage
  document.addEventListener('DOMContentLoaded', () => {
    const bookmarkBtn = document.querySelector('.bookmark-btn') as HTMLButtonElement;
    const shareBtn = document.querySelector('.share-btn') as HTMLButtonElement;

    if (!bookmarkBtn || !shareBtn) return;

    const currentUrl = window.location.href;

    // Initialize bookmark state
    function updateBookmarkState() {
      const bookmarks = JSON.parse(localStorage.getItem('bookmarked-articles') || '[]');
      const isBookmarked = bookmarks.includes(currentUrl);

      if (isBookmarked) {
        bookmarkBtn.classList.add('bookmarked');
        bookmarkBtn.title = 'Remove bookmark';
      } else {
        bookmarkBtn.classList.remove('bookmarked');
        bookmarkBtn.title = 'Bookmark this article';
      }
    }

    // Initialize state
    updateBookmarkState();

    // Bookmark toggle functionality
    bookmarkBtn.addEventListener('click', (e) => {
      e.preventDefault();

      try {
        const bookmarks = JSON.parse(localStorage.getItem('bookmarked-articles') || '[]');
        const isCurrentlyBookmarked = bookmarks.includes(currentUrl);

        if (isCurrentlyBookmarked) {
          // Remove bookmark
          const updatedBookmarks = bookmarks.filter((url: string) => url !== currentUrl);
          localStorage.setItem('bookmarked-articles', JSON.stringify(updatedBookmarks));
        } else {
          // Add bookmark
          bookmarks.push(currentUrl);
          localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarks));
        }

        // Update visual state
        updateBookmarkState();

        // Provide subtle feedback with button animation
        bookmarkBtn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          bookmarkBtn.style.transform = '';
        }, 150);
      } catch (error) {
        console.error('Error managing bookmark:', error);
      }
    });

    // Share functionality
    shareBtn.addEventListener('click', async (e) => {
      e.preventDefault();

      // Get comprehensive share data from meta tags
      const title =
        document.querySelector('meta[property="og:title"]')?.getAttribute('content') ||
        document.title;
      const description =
        document.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
        document.querySelector('meta[name="description"]')?.getAttribute('content') ||
        '';
      const image =
        document.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';
      const url =
        document.querySelector('meta[property="og:url"]')?.getAttribute('content') ||
        window.location.href;

      const shareData: any = {
        title: title,
        text: description,
        url: url,
      };

      try {
        // Try native Web Share API first
        if (navigator.share) {
          await navigator.share(shareData);
          return;
        }

        // Fallback: copy comprehensive share text to clipboard
        if (navigator.clipboard) {
          const shareText = `${title}\\n\\n${description}\\n\\nðŸ”— ${url}${image ? `\\n\\nðŸ–¼ï¸ ${image}` : ''}\\n\\n#PrakashRajBlog #TechBlog`;
          await navigator.clipboard.writeText(shareText);

          // Visual feedback
          const originalTitle = shareBtn.title;
          shareBtn.title = 'Share content copied!';
          shareBtn.style.transform = 'scale(0.9)';

          setTimeout(() => {
            shareBtn.style.transform = '';
            shareBtn.title = originalTitle;
          }, 2000);
        }
      } catch (error) {
        console.error('Error sharing:', error);
        // Ultimate fallback: copy just the URL
        try {
          await navigator.clipboard.writeText(url);
          shareBtn.title = 'Link copied!';
          setTimeout(() => {
            shareBtn.title = 'Share this article';
          }, 2000);
        } catch (e) {
          console.error('Failed to copy to clipboard:', e);
        }
      }
    }); // Force button reset on mouse events
    shareBtn.addEventListener('mouseup', () => {
      shareBtn.blur();
    });

    shareBtn.addEventListener('mouseleave', () => {
      shareBtn.blur();
    });
  });
</script>
